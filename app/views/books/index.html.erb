<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Books Collection</h1>
  <span class="badge bg-primary fs-6"><%= @total_books %> Total Books</span>
</div>

<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">
      <button class="btn btn-link text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#advancedSearch">
        Advanced Search & Filters
      </button>
    </h5>
  </div>
  <div id="advancedSearch" class="collapse <%= 'show' if @search_performed %>">
    <div class="card-body">
      <%= form_with url: search_books_path, method: :get, local: true, class: "row g-3" do |f| %>
        <div class="col-md-6">
          <%= f.label :query, "Search Books & Authors", class: "form-label" %>
          <%= f.text_field :query, placeholder: "Enter book title or author name...", 
                          class: "form-control", value: params[:query] %>
          <div class="form-text">Search through book titles and author names</div>
        </div>
        
        <div class="col-md-4">
          <%= f.label :subject_id, "Filter by Subject", class: "form-label" %>
          <%= f.select :subject_id, 
                      options_from_collection_for_select(@subjects, :id, :name, params[:subject_id]),
                      { prompt: "All Subjects" },
                      { class: "form-select" } %>
          <div class="form-text">Narrow results by book category</div>
        </div>
        
        <div class="col-md-2 d-flex align-items-end">
          <%= f.submit "Search", class: "btn btn-primary me-2" %>
          <%= link_to "Clear", books_path, class: "btn btn-outline-secondary" %>
        </div>
      <% end %>
      
      <% if @search_performed %>
        <div class="mt-3 pt-3 border-top">
          <h6>Search Results:</h6>
          <p class="mb-0">
            <% if params[:query].present? %>
              Text search: "<strong><%= params[:query] %></strong>"
            <% end %>
            <% if @selected_subject %>
              <%= " • " if params[:query].present? %>
              Subject: <strong><%= @selected_subject.name %></strong>
            <% end %>
            • Found <strong><%= @total_books %></strong> books
          </p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<div class="d-flex justify-content-center mb-4">
  <%= paginate @books %>
</div>

<% if @books.any? %>
  <div class="row">
    <% @books.each do |book| %>
      <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
          <% if book.cover_medium_url %>
            <img src="<%= book.cover_medium_url %>" class="card-img-top" style="height: 200px; object-fit: cover;" alt="<%= book.title %>">
          <% end %>
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">
              <%= highlight(book.title, params[:query]) if params[:query].present? %>
              <%= book.title unless params[:query].present? %>
            </h5>
            <p class="card-text">
              <strong>Authors:</strong> 
              <% book.authors.each do |author| %>
                <% if params[:query].present? %>
                  <%= link_to highlight(author.name, params[:query]), author_path(author), class: "text-decoration-none" %>
                <% else %>
                  <%= link_to author.name, author_path(author), class: "text-decoration-none" %>
                <% end %>
                <%= ", " unless author == book.authors.last %>
              <% end %>
            </p>
            <p class="card-text">
              <strong>Publisher:</strong> 
              <%= link_to book.publisher.name, publisher_path(book.publisher), class: "text-decoration-none" if book.publisher %>
            </p>
            <p class="card-text">
              <strong>Subjects:</strong>
              <% book.subjects.first(3).each do |subject| %>
                <span class="badge bg-<%= subject == @selected_subject ? 'warning' : 'secondary' %> me-1">
                  <%= link_to subject.name, subject_path(subject), class: "text-white text-decoration-none" %>
                </span>
              <% end %>
            </p>
            <p class="card-text"><small class="text-muted">Published: <%= book.publish_date %></small></p>
            <div class="mt-auto">
              <%= link_to "View Details", book_path(book), class: "btn btn-primary" %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="d-flex justify-content-center mt-4">
    <%= paginate @books %>
  </div>
<% else %>
  <div class="alert alert-info">
    <h4>No books found</h4>
    <% if @search_performed %>
      <p>No books match your search criteria. Try adjusting your search terms or filters.</p>
      <%= link_to "View All Books", books_path, class: "btn btn-primary" %>
    <% else %>
      <p>Use the search form above to find books by title, author, or subject category.</p>
    <% end %>
  </div>
<% end %>