<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Books Collection</h1>
  <span class="badge bg-primary fs-6"><%= @total_books %> Total Books</span>
</div>

<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">
      <button class="btn btn-link text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#advancedSearch" aria-expanded="<%= @search_performed ? 'true' : 'false' %>" aria-controls="advancedSearch">
        Advanced Search & Filters
      </button>
    </h5>
  </div>
  <div id="advancedSearch" class="collapse <%= 'show' if @search_performed %>">
    <div class="card-body">
      <%= form_with url: search_books_path, method: :get, local: true, class: "row g-3" do |f| %>
        <div class="col-md-6">
          <%= f.label :query, "Search Books & Authors", class: "form-label" %>
          <%= f.text_field :query, placeholder: "Enter book title or author name...", 
                          class: "form-control", value: params[:query] %>
          <div class="form-text">Search through book titles and author names</div>
        </div>
        
        <div class="col-md-4">
          <%= f.label :subject_id, "Filter by Subject", class: "form-label" %>
          <%= f.select :subject_id, 
                      options_from_collection_for_select(@subjects, :id, :name, params[:subject_id]),
                      { prompt: "All Subjects" },
                      { class: "form-select" } %>
          <div class="form-text">Narrow results by book category</div>
        </div>
        
        <div class="col-md-2 d-flex align-items-end">
          <%= f.submit "Search", class: "btn btn-primary me-2" %>
          <%= link_to "Clear", books_path, class: "btn btn-outline-secondary" %>
        </div>
      <% end %>
      
      <% if @search_performed %>
        <div class="mt-3 pt-3 border-top">
          <h6>Search Results:</h6>
          <p class="mb-0">
            <% if params[:query].present? %>
              Text search: "<strong><%= params[:query] %></strong>"
            <% end %>
            <% if @selected_subject %>
              <%= " • " if params[:query].present? %>
              Subject: <strong><%= @selected_subject.name %></strong>
            <% end %>
            • Found <strong><%= @total_books %></strong> 
            <%= @total_books == 1 ? 'book' : 'books' %>
          </p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<% if @books.respond_to?(:current_page) && @books.total_pages > 1 %>
  <div class="d-flex justify-content-center mb-4">
    <%= paginate @books %>
  </div>
<% end %>

<% if @books.any? %>
  <div class="row">
    <% @books.each do |book| %>
      <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
          <% if book.cover_medium_url.present? %>
            <img src="<%= book.cover_medium_url %>" class="card-img-top" style="height: 200px; object-fit: cover;" alt="Cover of <%= book.title %>">
          <% else %>
            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
              <div class="text-center text-muted">
                <i class="fas fa-book fa-3x mb-2"></i>
                <br>No Cover Available
              </div>
            </div>
          <% end %>
          
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">
              <% if params[:query].present? %>
                <%= highlight(book.title, params[:query]) %>
              <% else %>
                <%= book.title %>
              <% end %>
            </h5>
            
            <p class="card-text">
              <strong>Authors:</strong> 
              <% if book.authors.any? %>
                <% book.authors.each do |author| %>
                  <% if params[:query].present? %>
                    <%= link_to highlight(author.name, params[:query]), author_path(author), class: "text-decoration-none" %>
                  <% else %>
                    <%= link_to author.name, author_path(author), class: "text-decoration-none" %>
                  <% end %>
                  <%= ", " unless author == book.authors.last %>
                <% end %>
              <% else %>
                <em>Unknown Author</em>
              <% end %>
            </p>
            
            <p class="card-text">
              <strong>Publisher:</strong> 
              <% if book.publisher %>
                <%= link_to book.publisher.name, publisher_path(book.publisher), class: "text-decoration-none" %>
              <% else %>
                <em>Unknown Publisher</em>
              <% end %>
            </p>
            
            <% if book.subjects.any? %>
              <p class="card-text">
                <strong>Subjects:</strong>
                <% book.subjects.first(3).each do |subject| %>
                  <span class="badge bg-<%= subject == @selected_subject ? 'warning' : 'secondary' %> me-1">
                    <%= link_to subject.name, subject_path(subject), class: "text-white text-decoration-none" %>
                  </span>
                <% end %>
                <% if book.subjects.count > 3 %>
                  <span class="badge bg-light text-dark">+<%= book.subjects.count - 3 %> more</span>
                <% end %>
              </p>
            <% end %>
            
            <p class="card-text">
              <small class="text-muted">
                Published: <%= book.publish_date || 'Unknown' %>
                <% if book.number_of_pages %>
                  • <%= book.number_of_pages %> pages
                <% end %>
              </small>
            </p>
            
            <div class="mt-auto">
              <%= link_to "View Details", book_path(book), class: "btn btn-primary" %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <% if @books.respond_to?(:current_page) && @books.total_pages > 1 %>
    <div class="d-flex justify-content-center mt-4">
      <%= paginate @books %>
    </div>
  <% end %>
<% else %>
  <div class="alert alert-info">
    <h4>
      <% if @search_performed %>
        No books found
      <% else %>
        Welcome to our Book Collection
      <% end %>
    </h4>
    <% if @search_performed %>
      <p>No books match your search criteria. Try adjusting your search terms or filters.</p>
      <%= link_to "View All Books", books_path, class: "btn btn-primary" %>
    <% else %>
      <p>Use the search form above to find books by title, author, or subject category.</p>
    <% end %>
  </div>
<% end %>